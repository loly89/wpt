<!DOCTYPE html>
<html>

<head>
    <title>img-src-self-unique-origin</title>
    <script src="/resources/testharness.js"></script>
    <script src="/resources/testharnessreport.js"></script>
</head>

<body>
    <p>
        The origin of an URL is called "unique" when it is considered to be
        different from every origin, including itself. The origin of a
        data-url is unique. When the current origin is unique, the CSP source
        'self' must use its inherited policy's 'self' origin.
        https://w3c.github.io/webappsec-csp/#policy-self-origin
    </p>
    <script>
        var iframe = document.createElement("iframe");
        iframe.src = encodeURI(`data:text/html,
          <script>
              /* Add the CSP: img-src: 'self'. */
              var meta = document.createElement('meta');
              meta.httpEquiv = 'Content-Security-Policy';
              meta.content = "img-src 'self'";
              document.getElementsByTagName('head')[0].appendChild(meta);
              });
          </scr`+`ipt>

          This image should not be blocked by CSP:
          <img onload='window.parent.postMessage("Test PASS", "*")' src='data:image/gif;base64,R0lGODlhEAAQAMQAAORHHOVSKudfOulrSOp3WOyDZu6QdvCchPGolfO0o/XBs/fNwfjZ0frl3/zy7////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABAALAAAAAAQABAAAAVVICSOZGlCQAosJ6mu7fiyZeKqNKToQGDsM8hBADgUXoGAiqhSvp5QAnQKGIgUhwFUYLCVDFCrKUE1lBavAViFIDlTImbKC5Gm2hB0SlBCBMQiB0UjIQA7'></img>
        `);
        if (window.async_test) {
            async_test(t => {
                window.addEventListener("message", e => {
                    if (e.data == "Test PASS")
                      t.done();
                });
            }, "Image's url must still match with 'self'. Image must not be blocked.");
        }
        document.body.appendChild(iframe);
    </script>
</body>

</html>
